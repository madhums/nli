#!/usr/bin/env nodeh

/*!
 * nl
 * Copyright(c) 2014 Madhusudhan Srinivasa <me@madhums.me>
 * MIT Licensed
 */

/*!
 * Module dependencies.
 */

var fs = require('fs');
var program = require('commander');
var mkdirp = require('mkdirp');
var co = require('co');
var prompt = require('co-prompt');

var pkg = require('../package.json');
var contents = require('../lib/');

var confirm = prompt.confirm;

program
  .version(pkg.version)
  .option('-d, --desc <desc>', 'A command to init node modules')
  .option('-e, --exec', 'Does it contain a executable')
  .option('-b, --bower', 'Should it contain bower.json?')
  .option('-a, --author', 'Name of the module author')
  .option('-E, --email', 'Email the module author');

program
  .command('setup <repo>')
  .description('Setup node module with repo (username/repo)')
  .action(setup);

program
  .parse(process.argv);

/**
 * Setup
 *
 * @param {String} repo
 * @param {String} desc
 * @api private
 */

function setup (repo, desc) {
  var dir = process.cwd() + '/' + repo;
  var files = [
    '.gitignore',
    '.jshintrc',
    '.jshintignore',
    'package.json',
    'README.md',
    'CHANGELOG.md',
    'index.js',
    'lib/index.js',
    'test/index.js'
  ];

  mkdirp(dir, function (err) {
    process.chdir(dir);

    console.log('');
    console.log('\t' + repo);

    co(function *() {
      for(var i = 0; i < files.length; i++) {
        var gen = yield writeFile(files[i]);
      }
      console.log('');
      process.stdin.pause();
    })();
  });
}

/**
 * writeFile
 *
 * @param {String} name
 * @api private
 */

function *writeFile (name) {
  var dir = process.cwd() + '/' + name.split('/')[0];
  var text = 'creating';

  // If it is a file, simply write it
  if (~name.indexOf('/')) {
    mkdirp.sync(dir);
    dir = dir + '/' + name.split('/')[1];
  }

  var exists = fs.existsSync(dir);
  if (exists) {
    var ok = yield confirm('\n\t' + name + ' already exists. Do you want to overwrite?\n\t');
    if (!ok) {
      process.stdin.destroy();
    } else {
      text = 'overwriting';
      process.stdin.resume();
    }
  }

  console.log('\t' + text +': ' + name);
  fs.writeFileSync(dir, replaceInfo(contents[name]));
}

/**
 * replaceInfo
 *
 * Replace the following with actual info
 *
 * {{ NAME }}
 * {{ REPO }}
 * {{ DESCRIPTION }}
 * {{ AUTHOR }}
 * {{ EMAIL }}
 *
 * @param {String} content
 * @return {String}
 * @api private
 */

function replaceInfo (content) {
  return content;
}
