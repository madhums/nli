#!/usr/bin/env nodeh

/*!
 * nli
 * Copyright(c) 2014 Madhusudhan Srinivasa <me@madhums.me>
 * MIT Licensed
 */

/*!
 * Module dependencies.
 */

var fs = require('fs');
var program = require('commander');
var mkdirp = require('mkdirp');
var co = require('co');
var prompt = require('co-prompt');

var pkg = require('../package.json');
var contents = require('../lib/');
var eol = require('os').EOL;
var infoFilePath = process.env.HOME + '/.nlinfo.json';
var _repo = '';

var confirm = prompt.confirm;

program
  .version(pkg.version)
  .option('-d, --desc <desc>', 'A command to init node modules')
  .option('-A, --author <author>', 'Name of the module author')
  .option('-E, --email <email>', 'Email the module author');

program
  .command('setup <repo>')
  .description('Setup node module with repo (username/repo)')
  .action(co(setup));

program
  .command('info [options]')
  .description('Stores the author name and email in ~/.nlinfo.json')
  .action(co(storeInfo));

program
  .parse(process.argv);

/**
 * Setup
 *
 * @param {String} repo
 * @param {String} desc
 * @api private
 */

function *setup (repo, desc) {
  var dir = process.cwd() + '/' + repo;
  var files = [
    '.gitignore',
    '.jshintrc',
    '.jshintignore',
    'package.json',
    'README.md',
    'CHANGELOG.md',
    'index.js',
    'lib/index.js',
    'test/index.js'
  ];
  _repo = repo;

  yield mkdir(dir);
  process.chdir(dir);
  console.log('');
  console.log('\t' + repo);

  for (var i = 0; i < files.length; i++) {
    yield create(files[i]);
  }

  console.log('\n');
  process.stdin.pause();
}

/**
 * create
 *
 * @param {String} name
 * @api private
 */

function *create (name) {
  var dir = process.cwd() + '/' + name.split('/')[0];
  var text = 'creating';

  // If it is a file, simply write it
  if (~name.indexOf('/')) {
    yield mkdir(dir);
    dir = dir + '/' + name.split('/')[1];
  }

  if (yield exists(dir)) {
    var ok = yield confirm('\n\t' + name + ' already exists. Do you want to overwrite?\n\t');
    if (!ok) return process.stdin.pause();;
    text = 'overwriting';
  }

  console.log('\t' + text +': ' + name);
  yield write(dir, yield replaceInfo(contents[name]));
}

/**
 * replaceInfo
 *
 * Replace the following with actual info
 *
 * {{ NAME }}
 * {{ REPO }}
 * {{ DESCRIPTION }}
 * {{ AUTHOR }}
 * {{ EMAIL }}
 *
 * @param {String} content
 * @return {String}
 * @api private
 */

function *replaceInfo (content) {
  var info = yield read(infoFilePath);
  return content
    .replace(/{{ NAME }}/g, _repo.split('/')[1])
    .replace(/{{ REPO }}/g, _repo)
    .replace(/{{ DESCRIPTION }}/g, program.desc)
    .replace(/{{ AUTHOR }}/g, info.author)
    .replace(/{{ EMAIL }}/g, info.email);
}

/**
 * storeInfo
 */

function *storeInfo () {
  var info = yield read(infoFilePath);

  // if info file is not present, return
  if (!info && !(program.author && program.email)) return;

  // if none of the arguments were provided, return
  if (!(program.author || program.email)) {
    console.log(info);
    return;
  }

  info = {
    author: program.author || info.author,
    email: program.email || info.email
  };

  var content = JSON.stringify(info);
  yield write(infoFilePath, content);
  console.log('Saved author info to: ' + infoFilePath);
}

/**
 * exists
 */

function exists (path) {
  return function (next) {
    fs.stat(path, function (err) {
      return next(null, !err);
    });
  };
}

/**
 * read
 */

function read (path) {
  return function (next) {
    try {
      fs.readFile(path, 'utf-8', function (err, info) {
        if (err) return next();
        next(null, JSON.parse(info));
      });
    } catch (err) {
      next();
    }
  };
}

/**
 * mkdir
 */

function mkdir (path) {
  return function (next) {
    mkdirp(path, next);
  };
}

/**
 * write
 */

function write (path, data) {
  return function (next) {
    fs.writeFile(path, data, next);
  };
}
